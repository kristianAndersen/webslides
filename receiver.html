<!-- Receiver HTML file (receiver.html) -->
<!DOCTYPE html>
<html>
<head>
    <title>Chrome Cast Sender with Display Info</title>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
</head>
<body>
    <h1>Chrome Cast Sender</h1>
    <button id="castButton" disabled>Start Casting</button>
    <div id="displayInfo"></div>
    <div id="status"></div>

    <script>
        let session = null;
        const applicationID = chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID;
        const namespace = 'urn:x-cast:com.example.castmessage';

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            const sessionRequest = new chrome.cast.SessionRequest(applicationID);
            const apiConfig = new chrome.cast.ApiConfig(sessionRequest,
                sessionListener,
                receiverListener);
            chrome.cast.initialize(apiConfig, onInitSuccess, onError);
        }

        function sessionListener(newSession) {
            session = newSession;
            session.addUpdateListener(sessionUpdateListener);
            session.addMessageListener(namespace, receiverMessage);
            document.getElementById('status').textContent = 'Connected to ' + session.receiver.friendlyName;
            requestDisplayInfo();
        }

        function receiverListener(availability) {
            if (availability === chrome.cast.ReceiverAvailability.AVAILABLE) {
                document.getElementById('castButton').disabled = false;
                document.getElementById('status').textContent = 'Chromecast is available';
            } else {
                document.getElementById('castButton').disabled = true;
                document.getElementById('status').textContent = 'No Chromecast available';
            }
        }

        function onInitSuccess() {
            console.log('Init success');
        }

        function onError(error) {
            console.error('Error:', error);
            document.getElementById('status').textContent = 'Error: ' + error.description;
        }

        function sessionUpdateListener(isAlive) {
            if (!isAlive) {
                session = null;
                document.getElementById('status').textContent = 'Session ended';
                document.getElementById('displayInfo').innerHTML = '';
                document.getElementById('castButton').textContent = 'Start Casting';
            }
        }

        function receiverMessage(namespace, message) {
            console.log('receiverMessage', namespace, message);
            try {
                const displayInfo = JSON.parse(message);
                document.getElementById('displayInfo').innerHTML = `
                    <p>Width: ${displayInfo.width}px</p>
                    <p>Height: ${displayInfo.height}px</p>
                    <p>Aspect Ratio: ${displayInfo.aspectRatio}</p>
                `;
            } catch (e) {
                console.error('Error parsing message:', e);
            }
        }

        function requestDisplayInfo() {
            if (session) {
                session.sendMessage(namespace, 'REQUEST_DISPLAY_INFO', 
                    () => console.log('Message sent successfully'),
                    (error) => console.error('Error sending message:', error)
                );
            }
        }

        function launchApp() {
            chrome.cast.requestSession(
                function(newSession) {
                    session = newSession;
                    session.addUpdateListener(sessionUpdateListener);
                    session.addMessageListener(namespace, receiverMessage);
                    document.getElementById('status').textContent = 'Connected to ' + session.receiver.friendlyName;
                    document.getElementById('castButton').textContent = 'End Casting';
                    requestDisplayInfo();
                }, 
                onError
            );
        }

        function endSession() {
            if (session) {
                session.stop(
                    () => {
                        console.log('Session stopped successfully');
                        session = null;
                        document.getElementById('status').textContent = 'Session ended';
                        document.getElementById('displayInfo').innerHTML = '';
                        document.getElementById('castButton').textContent = 'Start Casting';
                    },
                    (error) => console.error('Error stopping session:', error)
                );
            }
        }

        document.getElementById('castButton').addEventListener('click', function() {
            if (session) {
                endSession();
            } else {
                launchApp();
            }
        });
    </script>
</body>
</html>


<!--<!DOCTYPE html>
<html>
<head>
    <title>Chrome Cast Receiver with Display Info</title>
    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>
    <h1>Chrome Cast Receiver</h1>
    <div id="message"></div>

    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        const options = new cast.framework.CastReceiverOptions();
        options.customNamespaces = {
            'urn:x-cast:com.example.castmessage': cast.framework.system.MessageType.STRING
        };

        function getDisplayInfo() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const aspectRatio = (width / height).toFixed(2);
            return { width, height, aspectRatio };
        }


        context.addCustomMessageListener('urn:x-cast:com.example.castmessage', function(event) {
    console.log('Message received:', event.data);
    if (event.data === 'REQUEST_DISPLAY_INFO') {
        const displayInfo = getDisplayInfo();
        console.log('Sending display info:', displayInfo);
        context.sendCustomMessage('urn:x-cast:com.example.castmessage', event.senderId, JSON.stringify(displayInfo));
    }
});


        context.start(options);
    </script>
</body>
</html>-->