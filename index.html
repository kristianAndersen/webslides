<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cast Sender with Device Scanning</title>
    <!-- Load Cast Framework -->
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
        let castContext = null;
        const applicationId = 'CC1AD845'; // Using default receiver for testing

        window['__onGCastApiAvailable'] = function(isAvailable, error) {
            if (isAvailable) {
                console.log('Cast API is available');
                initializeCastFramework();
            } else {
                console.error('Cast API is not available:', error);
                updateStatus('Cast API not available: ' + error);
            }
        };

        async function initializeCastFramework() {
            try {
                // Wait for cast framework to be ready
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Initialize cast framework
                castContext = cast.framework.CastContext.getInstance();
                
                // Set options
                castContext.setOptions({
                    receiverApplicationId: applicationId,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,
                    language: 'en-US',
                    resumeSavedSession: false
                });

                console.log('Cast Framework initialized');
                updateStatus('Cast Framework initialized');

                // Add cast state listener
                castContext.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    event => {
                        const state = event.castState || castContext.getCastState();
                        console.log('Cast State Changed:', state);
                        updateStatus('Cast State: ' + state);
                        updateDeviceList();
                    }
                );

                // Add session state listener
                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    event => {
                        console.log('Session State Changed:', event.sessionState);
                        updateStatus('Session State: ' + event.sessionState);
                    }
                );

                // Initial device check
                updateDeviceList();

            } catch (error) {
                console.error('Error initializing Cast Framework:', error);
                updateStatus('Init Error: ' + error.message);
            }
        }

        function updateDeviceList() {
            const state = castContext ? castContext.getCastState() : 'CONTEXT_NOT_INITIALIZED';
            const stateElement = document.getElementById('castState');
            stateElement.textContent = 'Cast State: ' + state;

            switch(state) {
                case cast.framework.CastState.NO_DEVICES_AVAILABLE:
                    stateElement.style.color = 'red';
                    break;
                case cast.framework.CastState.NOT_CONNECTED:
                    stateElement.style.color = 'orange';
                    break;
                case cast.framework.CastState.CONNECTED:
                    stateElement.style.color = 'green';
                    break;
                default:
                    stateElement.style.color = 'black';
            }
        }

        async function startCasting() {
            try {
                if (!castContext) {
                    throw new Error('Cast Framework not initialized');
                }

                console.log('Attempting to start casting...');
                updateStatus('Starting cast...');

                const currentSession = castContext.getCurrentSession();
                if (currentSession) {
                    console.log('Already connected to a session');
                    updateStatus('Already connected');
                    return;
                }

                const session = await castContext.requestSession();
                console.log('Cast session created:', session);
                updateStatus('Connected to Chromecast!');

            } catch (error) {
                console.error('Casting failed:', error);
                updateStatus('Casting failed: ' + (error.message || 'Unknown error'));
            }
        }

        function updateStatus(message) {
            console.log('Status:', message);
            document.getElementById('status').textContent = message;
        }
    </script>
    <style>
        .button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Cast Sender with Device Scanning</h1>
    <button class="button" onclick="startCasting()">Start Casting</button>
    <button class="button" onclick="updateDeviceList()">Refresh Device Status</button>
    <div id="castState" class="status">Cast State: Not initialized</div>
    <div id="status" class="status">Initializing...</div>
</body>
</html>



<!--<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Cast Sender</title>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) {
            console.log('Cast API available:', isAvailable);
            if (isAvailable) {
                initializeCastApi();
            } else {
                console.error('Cast API is not available');
                updateStatus('Cast API is not available');
            }
        };

        function initializeCastApi() {
            try {
                const context = cast.framework.CastContext.getInstance();
                console.log('Cast Context:', context);
                context.setOptions({
                    receiverApplicationId: 'ED052386', // Your custom receiver app ID
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                console.log('Cast API initialized successfully');
                updateStatus('Cast API initialized. Ready to connect.');
                
                console.log('Available Cast APIs:', Object.keys(chrome.cast));
                console.log('CastContext methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(context)));

                const castState = context.getCastState();
                console.log('Cast State:', castState);
                updateStatus('Current Cast State: ' + castState);

                context.addEventListener(cast.framework.CastContextEventType.CAST_STATE_CHANGED, function(event) {
                    console.log('Cast state changed:', event.castState);
                    updateStatus('Cast state changed: ' + event.castState);
                });
            } catch (error) {
                console.error('Error initializing Cast API:', error);
                updateStatus('Failed to initialize Cast API: ' + error.message);
            }
        }

        function requestSession() {
            const castContext = cast.framework.CastContext.getInstance();
            console.log('Requesting session...');
            castContext.requestSession()
                .then(function(session) {
                    console.log('Cast session started successfully:', session);
                    updateStatus('Connected to Chromecast!');
                })
                .catch(function(error) {
                    console.error('Error starting cast session:', error);
                    console.log('Error details:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
                    updateStatus('Failed to connect: ' + (error.message || 'Unknown error'));
                });
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('Status updated:', message);
        }

        function checkDeviceAvailability() {
    const context = cast.framework.CastContext.getInstance();
    console.log('Current Cast State:', context.getCastState());
    
    if ('requestSessionAndLaunchApp' in chrome.cast) {
        chrome.cast.requestSessionAndLaunchApp(
            null,
            sessionListener,
            errorHandler
        );
    } else {
        console.log('requestSessionAndLaunchApp not available');
    }
}

function sessionListener(session) {
    console.log('Session created successfully:', session);
}

function errorHandler(error) {
    console.error('Error:', error);
}



    </script>
</head>
<body>
    <h1>Diagnostic Google Cast Sender</h1>
    <button onclick="requestSession()">Connect to Chromecast</button>
    <p id="status">Not connected</p>

    <button onclick="checkDeviceAvailability()">Check Device Availability</button>

</body>
</html>-->