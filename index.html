<!DOCTYPE html>
<html>
<head>
    <title>Chrome Cast Sender with Display Info</title>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>
    <h1>Chrome Cast Sender</h1>
    <button id="castButton">Start Casting</button>
    <div id="displayInfo"></div>
    <div id="status"></div>

    <script>
        let session = null;

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            const castContext = cast.framework.CastContext.getInstance();
            castContext.setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            const castButton = document.getElementById('castButton');
            const statusDiv = document.getElementById('status');

            castButton.addEventListener('click', () => {
                if (session && session.status === cast.framework.SessionState.CONNECTED) {
                    endCurrentSession();
                } else {
                    statusDiv.textContent = 'Attempting to connect...';
                    castContext.requestSession()
                        .then(handleSessionSuccess)
                        .catch(handleSessionError);
                }
            });

            castContext.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, (event) => {
                switch(event.sessionState) {
                    case cast.framework.SessionState.NO_SESSION:
                        statusDiv.textContent = 'No active session';
                        session = null;
                        break;
                    case cast.framework.SessionState.SESSION_STARTING:
                        statusDiv.textContent = 'Session is starting...';
                        break;
                    case cast.framework.SessionState.SESSION_STARTED:
                        statusDiv.textContent = 'Session has started';
                        session = event.session;
                        setupMessageListener(session);
                        requestDisplayInfo(session);
                        break;
                    case cast.framework.SessionState.SESSION_START_FAILED:
                        statusDiv.textContent = 'Failed to start session';
                        session = null;
                        break;
                    case cast.framework.SessionState.SESSION_ENDING:
                        statusDiv.textContent = 'Session is ending...';
                        break;
                    case cast.framework.SessionState.SESSION_ENDED:
                        statusDiv.textContent = 'Session has ended';
                        session = null;
                        document.getElementById('displayInfo').innerHTML = '';
                        break;
                }
            });
        }

        function setupMessageListener(session) {
            if (session) {
                session.addMessageListener('urn:x-cast:com.example.castmessage', function(namespace, message) {
                    const displayInfo = JSON.parse(message);
                    document.getElementById('displayInfo').innerHTML = `
                        <p>Width: ${displayInfo.width}px</p>
                        <p>Height: ${displayInfo.height}px</p>
                        <p>Aspect Ratio: ${displayInfo.aspectRatio}</p>
                    `;
                });
            }
        }

        function requestDisplayInfo(session) {
            if (session) {
                session.sendMessage('urn:x-cast:com.example.castmessage', 'REQUEST_DISPLAY_INFO')
                    .then(() => {
                        console.log('Message sent successfully');
                    })
                    .catch(error => console.error('Error sending message:', error));
            } else {
                console.error('Session is null, cannot send message.');
            }
        }

        function handleSessionSuccess(s) {
            session = s;
            document.getElementById('status').textContent = 'Connected successfully';
            setupMessageListener(session);
            requestDisplayInfo(session);
        }

        function handleSessionError(err) {
            console.error('Error:', err);
            let errorMessage = 'Failed to start casting session';
            if (err.code === 'cancel') {
                errorMessage = 'Casting was cancelled';
            }
            document.getElementById('status').textContent = errorMessage;
            session = null;
        }

        function endCurrentSession() {
            if (session) {
                session.endSession(true)
                    .then(() => {
                        document.getElementById('status').textContent = 'Session ended';
                        document.getElementById('displayInfo').innerHTML = '';
                        session = null;
                    })
                    .catch((err) => {
                        console.error('Error ending session:', err);
                        document.getElementById('status').textContent = 'Error disconnecting from casting device';
                    });
            }
        }
    </script>
</body>
</html>